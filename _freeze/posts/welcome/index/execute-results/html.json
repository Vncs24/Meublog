{
  "hash": "06b38a6e8a2fb82aa45a45c38c0eb2d0",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Mapa linha SPTrans\"\nauthor: \"Vinícius Fernandes\"\ndate: \"2025-11-23\"\ncategories: [python, code, sptrans]\nimage: \"SPTrans_logo.png\"\njupyter: python3\n---\n\nNeste post, mostramos como é possível visualizar, em tempo real, a posição de ônibus de uma linha específica em São Paulo.\nUtilizando dados da API do sistema Olho Vivo da SPTrans, o código coleta informações sobre as paradas e veículos ativos e gera um mapa interativo, permitindo acompanhar a circulação da linha de forma clara e visual.\nEsta visualização é útil para entender a distribuição de paradas, identificar veículos em movimento e explorar os dados de transporte público de forma dinâmica.\n\n**Explicação breve do código**\n\nO código em Python realiza três funções principais: autenticação, consulta de dados e geração do mapa.\n\nAutenticação: usa um token fornecido pela SPTrans para acessar a API.\nConsulta de dados: recupera o código da linha de ônibus, todas as paradas e a posição dos veículos em tempo real.\nGeração do mapa: utiliza a biblioteca `folium` para criar um mapa interativo, colocando marcadores azuis para as paradas e vermelhos para os veículos.\nPor fim, o mapa é salvo em um arquivo HTML, que pode ser incorporado em blogs ou visualizado diretamente no navegador.\n\n::: {#4b807624 .cell execution_count=1}\n``` {.python .cell-code}\nimport requests\nimport folium\n\nTOKEN = \"2692e179ba171bd5ae0a43849d0692b2d578551930c3ae3d78bc097101349160\"\nBASE = \"http://api.olhovivo.sptrans.com.br/v2.1\"\nsession = requests.Session()\n\ndef autenticar():\n    url = f\"{BASE}/Login/Autenticar\"\n    r = session.post(url, params={\"token\": TOKEN})\n    return r.text.lower() == \"true\"\n\ndef get_codigo_linha(linha, sentido=None):\n    url = f\"{BASE}/Linha/Buscar\"\n    r = session.get(url, params={\"termosBusca\": linha})\n    data = r.json()\n    if not data:\n        return None\n    if sentido is None:\n        return data[0].get(\"cl\")\n    for item in data:\n        if item.get(\"sl\") == sentido:\n            return item.get(\"cl\")\n    return data[0].get(\"cl\")\n\ndef get_paradas(codigo):\n    url = f\"{BASE}/Parada/BuscarParadasPorLinha\"\n    r = session.get(url, params={\"codigoLinha\": codigo})\n    return r.json() if r.ok else []\n\ndef get_veiculos(codigo):\n    url = f\"{BASE}/Posicao/Linha\"\n    r = session.get(url, params={\"codigoLinha\": codigo})\n    data = r.json()\n    return data.get(\"vs\", []) if data else []\n\ndef gerar_mapa(linha):\n    if not autenticar():\n        print(\"Falha na autenticação. Verifique seu token.\")\n        return\n\n    codigo1 = get_codigo_linha(linha, sentido=1)\n    codigo2 = get_codigo_linha(linha, sentido=2)\n\n    paradas = []\n    if codigo1:\n        paradas += get_paradas(codigo1)\n    if codigo2:\n        paradas += get_paradas(codigo2)\n\n    veiculos = []\n    if codigo1:\n        veiculos += get_veiculos(codigo1)\n    if codigo2:\n        veiculos += get_veiculos(codigo2)\n\n    if paradas:\n        lat0, lon0 = float(paradas[0][\"py\"]), float(paradas[0][\"px\"])\n    elif veiculos:\n        lat0, lon0 = float(veiculos[0][\"py\"]), float(veiculos[0][\"px\"])\n    else:\n        lat0, lon0 = -23.55, -46.63\n        print(\"Nenhuma parada ou veículo encontrado. Mapa centralizado em São Paulo.\")\n\n    mapa = folium.Map(location=[lat0, lon0], zoom_start=13)\n\n    if paradas:\n        for p in paradas:\n            try:\n                lat, lon = float(p[\"py\"]), float(p[\"px\"])\n                folium.Marker(location=[lat, lon], popup=p.get(\"np\",\"\"), icon=folium.Icon(color=\"blue\", icon=\"bus\")).add_to(mapa)\n            except:\n                continue\n    else:\n        print(\"Nenhuma parada encontrada para esta linha.\")\n\n    if veiculos:\n        for v in veiculos:\n            try:\n                lat, lon = float(v[\"py\"]), float(v[\"px\"])\n                folium.Marker(location=[lat, lon], popup=v.get(\"p\",\"\"), icon=folium.Icon(color=\"red\", icon=\"car\")).add_to(mapa)\n            except:\n                continue\n    else:\n        print(\"Nenhum veículo ativo encontrado para esta linha.\")\n\n    pontos = [(float(p[\"py\"]), float(p[\"px\"])) for p in paradas if p.get(\"py\") and p.get(\"px\")]\n    if pontos:\n        mapa.fit_bounds(mapa.get_bounds())\n    else:\n        mapa.fit_bounds([[-23.55, -46.63], [-23.55, -46.63]])\n\n    arquivo = f\"mapa_linha_{linha}.html\"\n    mapa.save(arquivo)\n\n\nif __name__ == \"__main__\":\n    gerar_mapa(\"701A-10\")\n```\n:::\n\n\n<iframe src=\"mapa_linha_701A-10.html\" width=\"100%\" height=\"600\"></iframe>\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}